# adapted from https://github.com/tptee/node-webworker-threads/blob/master/appveyor.yml

language: node_js

env:
  global:
    - secure: CdBNOl0sFTumjyDQqE3Kz/l9h0Oqwz5VajBnxD4JxYZhVsd6iJ/qoPzte0ogsUYKtC9eHCa45vAZJ+IFtxe7oHFUxn4YNjoNuv2u9+ZmNvJDMY5do5KNoT7v+lBMq7BCXOCrwtNo0emGBW7OZ6fcWhc8clb+t/ixo6ADJN7M0yzm1JuopKM0NDB8HhwDcuiTcZrlPD9aPSfQf/0mUVNQfg204WsAzaUAlIn8qViGlVFDAR3qoBi1kH9AhHF3SAkNQ9wzoGAA/0m3AOAw90LLvRycjGkLbJTVuLGLzXjHwW4DkCj+KsFj90uoEnIrzZhv5IUhrpgpT20SgObg/B5oL7ZEawLIgW3aopqxEE/JRyBj686O4BYRyjIL77Kqhs+qOKWknpgPeJ+2PATACAuN2eriGiO3kB3ZdlkbtwHZq5935MyWPiIQCNVZ5gYq4QfsCHiRdXrNzJChuede8KWLr/rTvWB530tgiPS9NW2WJUwclPucD1oNqdeWkaRSnCV6VC6dJmeDPnCKvSxAz1HeAIaleeAqGG2+0fo9QOaLfKuBBvNs0S1Rur7d1ZcrbaAVgy3oW0a/UNeEJ2m/HAHU8ofAulIuP5tlEB5tNDLtuSVvPVY+vAbcmkqAvrFjbKcuARPBCvMk3YhibuE3uxC+gDBLc7Ok6JHFdEu3KESvjv8=

os:
- linux
- osx

node_js:
- '4'
- '6'
- '8'


addons:
  apt:
    sources: ['ubuntu-toolchain-r-test']
    packages: ['g++-4.8']
    
sudo: false

before_install:
# Use gcc 4.8 on linux and clang on osx
- if [[ "$TRAVIS_OS_NAME" == "linux" ]]; then export CXX=g++-4.8; fi
# get commit message
- COMMIT_MESSAGE=$(git show -s --format=%B $TRAVIS_COMMIT | tr -d '\n')
# put local node_modules on PATH
- export PATH=./node_modules/.bin/:$PATH
# put global node-gyp on PATH
- eval npm install -g node-gyp

- PUBLISH_BINARY=false
# if we are building a tag then publish
- if [[ $TRAVIS_BRANCH == `git describe --tags --always HEAD` ]]; then PUBLISH_BINARY=true; fi;
# or if we put [publish binary] in the commit message
- if test "${COMMIT_MESSAGE#*'[publish binary]'}" != "$COMMIT_MESSAGE"; then PUBLISH_BINARY=true; fi;

install:
# ensure source install works
- eval npm install --build-from-source

script:
- if [[ $PUBLISH_BINARY == true ]]; then
    node-pre-gyp package;
    node-pre-gyp-github publish;
  fi;
- node-pre-gyp clean
- node-gyp clean

after_success:
# if success then query and display all published binaries
- node-pre-gyp info